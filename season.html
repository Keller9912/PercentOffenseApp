<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Season Player % Offense</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .data-table td.player-link {
      color: #3b82f6;
      cursor: pointer;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s;
    }

    .data-table td.player-link:hover {
      color: #1d4ed8;
      text-decoration: underline;
    }

    .data-table td.team-link {
      color: #10b981;
      cursor: pointer;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s;
    }

    .data-table td.team-link:hover {
      color: #059669;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <a href="index.html" class="back-button">← Back to Home</a>
      <h1>Fantasy Football Dashboard</h1>
      <p>Player % Offense - Season Averages</p>
    </div>

    <div class="content">
      <h2 class="page-title">Season Averages</h2>
      <div style="display: flex; justify-content: center; width: 100%;">
        <div class="filters">
          <div class="filter-dropdown" id="seasonPlayerDropdown">
            <button type="button" class="filter-button" id="seasonPlayerDropdownBtn">Player <span class="filter-arrow">▼</span></button>
            <div class="filter-dropdown-menu" id="seasonPlayerDropdownMenu">
              <input type="text" class="filter-search-input" id="seasonPlayerSearch" placeholder="Search players..." autocomplete="off" />
              <div id="seasonPlayerOptions"></div>
            </div>
          </div>
          <div class="filter-dropdown" id="seasonGamesDropdown">
            <button type="button" class="filter-button" id="seasonGamesDropdownBtn">Games Played <span class="filter-arrow">▼</span></button>
            <div class="filter-dropdown-menu" id="seasonGamesDropdownMenu"></div>
          </div>
          <div class="filter-dropdown" id="seasonTeamDropdown">
            <button type="button" class="filter-button" id="seasonTeamDropdownBtn">Team <span class="filter-arrow">▼</span></button>
            <div class="filter-dropdown-menu" id="seasonTeamDropdownMenu"></div>
          </div>
          <div class="filter-dropdown" id="seasonPosDropdown">
            <button type="button" class="filter-button" id="seasonPosDropdownBtn">Position <span class="filter-arrow">▼</span></button>
            <div class="filter-dropdown-menu" id="seasonPosDropdownMenu"></div>
          </div>
        </div>
      </div>
      <table id="seasonTable" class="data-table">
        <thead>
          <tr>
            <th class="sortable" data-sort="name">Player Name</th>
            <th class="sortable" data-sort="pos">Pos</th>
            <th class="sortable" data-sort="team">Team</th>
            <th class="sortable" data-sort="games">Games Played</th>
            <th class="sortable" data-sort="snaps">Snaps</th>
            <th class="sortable" data-sort="targets">Targets</th>
            <th class="sortable" data-sort="rushes">Rushes</th>
            <th class="sortable" data-sort="opportunities">Opportunities</th>
            <th class="sortable" data-sort="touches">Touches</th>
            <th class="sortable" data-sort="snap_pct">Snap %</th>
            <th class="sortable" data-sort="ppr">PPR</th>
            <th class="sortable" data-sort="offense_pct">% Offense</th>
          </tr>
        </thead>
        <tbody>
          <!-- Data rows will be inserted here -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Set your API URL here
    const url = "https://script.google.com/macros/s/AKfycbxTRNhPxu9QFv3hdYaaS0tMH7ZekFtvrGaX-d-LyXgm2LeqfXlu-ELiSZII85Gy4w2L6Q/exec";

    let playerArr = [];
    let allPlayers = [];
    let selectedPlayers = [];
    let currentFiltered = [];
    let currentSort = { column: null, asc: true };

    // --- Player Search Filter ---
    function renderPlayerOptions(filter = "") {
      const optionsDiv = document.getElementById('seasonPlayerOptions');
      const lower = filter.toLowerCase();
      optionsDiv.innerHTML = allPlayers
        .filter(name => name.toLowerCase().includes(lower))
        .map(name => `
          <div class="filter-option${selectedPlayers.includes(name) ? ' selected' : ''}" data-value="${name}">
            <span class="filter-checkmark">✔</span>
            <span class="filter-option-text">${name}</span>
          </div>
        `).join("");
      
      Array.from(optionsDiv.children).forEach(child => {
        child.onclick = function(e) {
          e.stopPropagation();
          const value = child.dataset.value;
          if (selectedPlayers.includes(value)) {
            selectedPlayers = selectedPlayers.filter(v => v !== value);
          } else {
            selectedPlayers.push(value);
          }
          renderPlayerOptions(document.getElementById('seasonPlayerSearch').value);
          applyCustomFilters();
        };
      });
    }

    // Dropdown open/close logic
    function setupDropdown(dropdownId, btnId, menuId) {
      const dropdown = document.getElementById(dropdownId);
      const btn = document.getElementById(btnId);
      const menu = document.getElementById(menuId);
      btn.onclick = function(e) {
        e.stopPropagation();
        closeAllDropdowns();
        menu.classList.toggle('open');
        btn.classList.toggle('open');
      };
      document.addEventListener('click', function(e) {
        if (!dropdown.contains(e.target)) {
          menu.classList.remove('open');
          btn.classList.remove('open');
        }
      });
    }

    function closeAllDropdowns() {
      document.querySelectorAll('.filter-dropdown-menu').forEach(m => m.classList.remove('open'));
      document.querySelectorAll('.filter-button').forEach(b => b.classList.remove('open'));
    }

    async function loadSeasonData() {
      if (!url) return;
      
      try {
        const response = await fetch(url);
        const data = await response.json();
        console.log('Fetched API data:', data);
        
        const grouped = {};
        data.forEach(row => {
          const id = row["id"];
          if (!grouped[id]) {
            grouped[id] = {
              id: id,
              name: row["player"] || "",
              pos: row["pos"] || "",
              team: row["team"] || "",
              games: 0,
              snaps: 0,
              team_snaps: 0,
              targets: 0,
              rushes: 0,
              opportunities: 0,
              touches: 0,
              ppr: 0,
              weeks: []
            };
          }
          grouped[id].games += 1;
          grouped[id].snaps += Number(row["snaps"] || 0);
          grouped[id].team_snaps += Number(row["team_snaps"] || 0);
          grouped[id].targets += Number(row["targets"] || 0);
          grouped[id].rushes += Number(row["rushes"] || 0);
          grouped[id].opportunities += Number(row["opportunities"] || 0);
          grouped[id].touches += Number(row["touches"] || 0);
          grouped[id].ppr += Number(row["fpts_ppr"] || 0);
          grouped[id].weeks.push(row["week"]);
        });

        playerArr = Object.values(grouped).map(player => {
          const snap_pct = player.team_snaps ? (player.snaps / player.team_snaps * 100) : 0;
          const offense_pct = player.team_snaps ? (player.opportunities / player.team_snaps * 100) : 0;
          return {
            ...player,
            snap_pct: snap_pct,
            offense_pct: offense_pct
          };
        });
        console.log('Aggregated playerArr:', playerArr);

        allPlayers = [...new Set(playerArr.map(p => p.name))].sort();
        renderPlayerOptions();
        setupCustomFilters();
        setupDropdown('seasonPlayerDropdown', 'seasonPlayerDropdownBtn', 'seasonPlayerDropdownMenu');
        
        document.getElementById('seasonPlayerSearch').oninput = function(e) {
          renderPlayerOptions(this.value);
        };
        
        // Default sort by % Offense descending
        currentFiltered = [...playerArr].sort((a, b) => b.offense_pct - a.offense_pct);
        currentSort = { column: 'offense_pct', asc: false };
        renderTable(currentFiltered);
        updateSortIndicators();
        
      } catch (error) {
        console.error('Error loading season data:', error);
      }
    }

    function setupCustomFilters() {
      // Helper to build menu
      function buildMenu(menuId, options, selected, onChange) {
        const menu = document.getElementById(menuId);
        menu.innerHTML = options.map(opt => `
          <div class="filter-option${selected.includes(opt) ? ' selected' : ''}" data-value="${opt}">
            <span class="filter-checkmark">✔</span>
            <span class="filter-option-text">${opt}</span>
          </div>
        `).join('');
        Array.from(menu.children).forEach(child => {
          child.onclick = function(e) {
            e.stopPropagation();
            child.classList.toggle('selected');
            onChange();
          };
        });
      }

      // Get unique options
      const gamesPlayed = [...new Set(playerArr.map(d => d.games))].sort((a,b)=>a-b);
      const teams = [...new Set(playerArr.map(d => d.team))].sort();
      const positions = [...new Set(playerArr.map(d => d.pos))].sort();
      let selectedGames = [];
      let selectedTeams = [];
      let selectedPositions = [];

      function applyCustomFilters() {
        selectedGames = Array.from(document.querySelectorAll('#seasonGamesDropdownMenu .filter-option.selected')).map(d => d.dataset.value);
        selectedTeams = Array.from(document.querySelectorAll('#seasonTeamDropdownMenu .filter-option.selected')).map(d => d.dataset.value);
        selectedPositions = Array.from(document.querySelectorAll('#seasonPosDropdownMenu .filter-option.selected')).map(d => d.dataset.value);
        
        let filtered = playerArr;
        if (selectedPlayers.length) filtered = filtered.filter(p => selectedPlayers.includes(p.name));
        if (selectedGames.length) filtered = filtered.filter(p => selectedGames.includes(String(p.games)));
        if (selectedTeams.length) filtered = filtered.filter(p => selectedTeams.includes(p.team));
        if (selectedPositions.length) filtered = filtered.filter(p => selectedPositions.includes(p.pos));
        
        currentFiltered = filtered;
        
        // Preserve current sort
        if (currentSort.column) {
          let sorted = [...currentFiltered].sort((a, b) => {
            let valA = a[currentSort.column];
            let valB = b[currentSort.column];
            if (["name", "team"].includes(currentSort.column)) {
              valA = valA.toLowerCase();
              valB = valB.toLowerCase();
              if (valA < valB) return currentSort.asc ? -1 : 1;
              if (valA > valB) return currentSort.asc ? 1 : -1;
              return 0;
            } else {
              valA = Number(valA);
              valB = Number(valB);
              if (valA < valB) return currentSort.asc ? -1 : 1;
              if (valA > valB) return currentSort.asc ? 1 : -1;
              return 0;
            }
          });
          currentFiltered = sorted;
        }
        renderTable(currentFiltered);
        updateSortIndicators();
      }

      // Make applyCustomFilters globally available
      window.applyCustomFilters = applyCustomFilters;

      buildMenu('seasonGamesDropdownMenu', gamesPlayed, selectedGames, applyCustomFilters);
      buildMenu('seasonTeamDropdownMenu', teams, selectedTeams, applyCustomFilters);
      buildMenu('seasonPosDropdownMenu', positions, selectedPositions, applyCustomFilters);

      setupDropdown('seasonGamesDropdown', 'seasonGamesDropdownBtn', 'seasonGamesDropdownMenu');
      setupDropdown('seasonTeamDropdown', 'seasonTeamDropdownBtn', 'seasonTeamDropdownMenu');
      setupDropdown('seasonPosDropdown', 'seasonPosDropdownBtn', 'seasonPosDropdownMenu');
    }

    function renderTable(data) {
      const tableBody = document.querySelector('#seasonTable tbody');
      tableBody.innerHTML = "";
      if (!data || data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="12">No data available</td></tr>';
        console.warn('renderTable called with empty data:', data);
        return;
      }
      data.forEach(player => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="player-link" onclick="window.location.href='player-charts.html?player=${encodeURIComponent(player.name)}'">${player.name}</td>
          <td>${player.pos}</td>
          <td class="team-link" onclick="window.location.href='team-charts.html?team=${encodeURIComponent(player.team)}'">${player.team}</td>
          <td>${player.games}</td>
          <td>${player.snaps}</td>
          <td>${player.targets}</td>
          <td>${player.rushes}</td>
          <td>${player.opportunities}</td>
          <td>${player.touches}</td>
          <td>${player.snap_pct.toFixed(1)}</td>
          <td>${player.ppr.toFixed(1)}</td>
          <td class="percent-offense">${player.offense_pct.toFixed(1)}</td>
        `;
        tableBody.appendChild(tr);
      });
    }

    function sortTable(column) {
      if (currentSort.column === column) {
        currentSort.asc = !currentSort.asc;
      } else {
        currentSort.column = column;
        // Default to descending for offense_pct and ppr, ascending otherwise
        currentSort.asc = (column === 'offense_pct' || column === 'ppr') ? false : true;
      }
      
      // Get current filtered data and apply sort
      const selectedGames = Array.from(document.querySelectorAll('#seasonGamesDropdownMenu .filter-option.selected')).map(d => d.dataset.value);
      const selectedTeams = Array.from(document.querySelectorAll('#seasonTeamDropdownMenu .filter-option.selected')).map(d => d.dataset.value);
      const selectedPositions = Array.from(document.querySelectorAll('#seasonPosDropdownMenu .filter-option.selected')).map(d => d.dataset.value);
      
      let filtered = playerArr;
      if (selectedPlayers.length) filtered = filtered.filter(p => selectedPlayers.includes(p.name));
      if (selectedGames.length) filtered = filtered.filter(p => selectedGames.includes(String(p.games)));
      if (selectedTeams.length) filtered = filtered.filter(p => selectedTeams.includes(p.team));
      if (selectedPositions.length) filtered = filtered.filter(p => selectedPositions.includes(p.pos));
      
      let sorted = [...filtered].sort((a, b) => {
        let valA = a[column];
        let valB = b[column];
        if (["name", "team"].includes(column)) {
          valA = valA.toLowerCase();
          valB = valB.toLowerCase();
          if (valA < valB) return currentSort.asc ? -1 : 1;
          if (valA > valB) return currentSort.asc ? 1 : -1;
          return 0;
        } else {
          valA = Number(valA);
          valB = Number(valB);
          if (valA < valB) return currentSort.asc ? -1 : 1;
          if (valA > valB) return currentSort.asc ? 1 : -1;
          return 0;
        }
      });
      currentFiltered = sorted;
      renderTable(currentFiltered);
    }

    // Attach sort handlers and manage sort indicators
    function updateSortIndicators() {
      document.querySelectorAll('#seasonTable th.sortable').forEach(th => {
        th.classList.remove('sorted-asc', 'sorted-desc');
        if (th.dataset.sort === currentSort.column) {
          th.classList.add(currentSort.asc ? 'sorted-asc' : 'sorted-desc');
        }
      });
    }

    // Initialize sorting when DOM is loaded
    function initializeSorting() {
      document.querySelectorAll("#seasonTable th.sortable").forEach(th => {
        th.style.cursor = "pointer";
        th.onclick = () => {
          sortTable(th.dataset.sort);
          updateSortIndicators();
        };
      });
    }

    window.addEventListener("DOMContentLoaded", () => {
      loadSeasonData().then(() => {
        initializeSorting();
      });
    });
  </script>
</body>
</html>