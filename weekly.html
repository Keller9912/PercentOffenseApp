<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weekly Stats</title>
<link rel="stylesheet" href="styles.css">
<!-- Sortable styles are now in styles.css -->
</head>
<body>
<div class="container">
    <div class="header">
        <a href="index.html" class="back-button">← Back to Home</a>
        <h1>Fantasy Football Dashboard</h1>
        <p>Player % Offense - Weekly Stats</p>
        </div>

        <div style="display: flex; justify-content: center; width: 100%;">
            <div class="filters">
                <div class="filter-dropdown" id="weekDropdown">
                    <button type="button" class="filter-button" id="weekDropdownBtn">Week <span class="filter-arrow">▼</span></button>
                    <div class="filter-dropdown-menu" id="weekDropdownMenu"></div>
                </div>
                <div class="filter-dropdown" id="teamDropdown">
                    <button type="button" class="filter-button" id="teamDropdownBtn">Team <span class="filter-arrow">▼</span></button>
                    <div class="filter-dropdown-menu" id="teamDropdownMenu"></div>
                </div>
                <div class="filter-dropdown" id="posDropdown">
                    <button type="button" class="filter-button" id="posDropdownBtn">Position <span class="filter-arrow">▼</span></button>
                    <div class="filter-dropdown-menu" id="posDropdownMenu"></div>
                </div>
            </div>
        </div>

    <table class="data-table" id="weeklyTable">
        <thead>
            <tr>
                <th class="sortable" data-key="week">Week</th>
                <th class="sortable" data-key="player">Player Name</th>
                <th class="sortable" data-key="team">Team</th>
                <th class="sortable" data-key="pos">Pos</th>
                <th class="sortable" data-key="snaps">Snaps</th>
                <th class="sortable" data-key="team_snaps">Team Snaps</th>
                <th class="sortable" data-key="snap_pct">Snap %</th>
                <th class="sortable" data-key="touches">Touches</th>
                <th class="sortable" data-key="opportunities">Opportunities</th>
                <th class="sortable" data-key="fpts_ppr">FPTS PPR</th>
                <th class="sortable" data-key="pct_offense">% Offense</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
const table = document.getElementById('weeklyTable').getElementsByTagName('tbody')[0];
let weeklyData = [];
let sortOrder = {}; // store sort order per column

// Fetch data from Apps Script API
fetch('https://script.google.com/macros/s/AKfycbxTRNhPxu9QFv3hdYaaS0tMH7ZekFtvrGaX-d-LyXgm2LeqfXlu-ELiSZII85Gy4w2L6Q/exec')
.then(res => res.json())
.then(data => {
    weeklyData = data.map(item => ({
        week: item.week || 0,
        player: item.player || 'N/A',
        team: item.team || 'N/A',
        pos: item.pos || 'N/A',
        snaps: item.snaps || 0,
        team_snaps: item.team_snaps || 0,
        snap_pct: item.snap_pct || 0,
        touches: item.touches || 0,
        opportunities: item.opportunities || 0,
        fpts_ppr: item.fpts_ppr || 0,
        pct_offense: item.pct_offense != null ? (parseFloat(item.pct_offense) * 100).toFixed(1) : 0
    }));
    setupCustomFilters();
    // Default sort by % Offense descending
    sortOrder = { pct_offense: 'desc' };
    const sorted = [...weeklyData].sort((a, b) => b.pct_offense - a.pct_offense);
    renderTable(sorted);
    makeSortable();
});

function setupCustomFilters() {
    // Helper to build menu
    function buildMenu(menuId, options, selected, onChange) {
        const menu = document.getElementById(menuId);
        menu.innerHTML = options.map(opt => `
            <div class="filter-option${selected.includes(opt) ? ' selected' : ''}" data-value="${opt}">
                <span class="filter-checkmark">✔</span>
                <span class="filter-option-text">${opt}</span>
            </div>
        `).join('');
        Array.from(menu.children).forEach(child => {
            child.onclick = function(e) {
                e.stopPropagation();
                child.classList.toggle('selected');
                onChange();
            };
        });
    }

    // Dropdown open/close logic
    function setupDropdown(dropdownId, btnId, menuId) {
        const dropdown = document.getElementById(dropdownId);
        const btn = document.getElementById(btnId);
        const menu = document.getElementById(menuId);
        btn.onclick = function(e) {
            e.stopPropagation();
            closeAllDropdowns();
            menu.classList.toggle('open');
            btn.classList.toggle('open');
        };
        document.addEventListener('click', function(e) {
            if (!dropdown.contains(e.target)) {
                menu.classList.remove('open');
                btn.classList.remove('open');
            }
        });
    }
    function closeAllDropdowns() {
        document.querySelectorAll('.filter-dropdown-menu').forEach(m => m.classList.remove('open'));
        document.querySelectorAll('.filter-button').forEach(b => b.classList.remove('open'));
    }

    // Get unique options
    const weeks = [...new Set(weeklyData.map(d => d.week))].sort((a,b)=>a-b);
    const teams = [...new Set(weeklyData.map(d => d.team))].sort();
    const positions = [...new Set(weeklyData.map(d => d.pos))].sort();
    let selectedWeeks = [];
    let selectedTeams = [];
    let selectedPositions = [];

    function applyCustomFilters() {
        selectedWeeks = Array.from(document.querySelectorAll('#weekDropdownMenu .filter-option.selected')).map(d => d.dataset.value);
        selectedTeams = Array.from(document.querySelectorAll('#teamDropdownMenu .filter-option.selected')).map(d => d.dataset.value);
        selectedPositions = Array.from(document.querySelectorAll('#posDropdownMenu .filter-option.selected')).map(d => d.dataset.value);
        let filtered = weeklyData;
        if (selectedWeeks.length) filtered = filtered.filter(d => selectedWeeks.includes(String(d.week)));
        if (selectedTeams.length) filtered = filtered.filter(d => selectedTeams.includes(d.team));
        if (selectedPositions.length) filtered = filtered.filter(d => selectedPositions.includes(d.pos));
        // Preserve current sort
        let sortKey = Object.keys(sortOrder).find(k => sortOrder[k]);
        let sortDir = sortKey ? sortOrder[sortKey] : null;
        if (sortKey) {
            filtered = [...filtered].sort((a, b) => {
                if(typeof a[sortKey] === 'number' || !isNaN(a[sortKey])) {
                    return sortDir === 'asc' ? a[sortKey]-b[sortKey] : b[sortKey]-a[sortKey];
                } else {
                    return sortDir === 'asc' 
                        ? a[sortKey].localeCompare(b[sortKey]) 
                        : b[sortKey].localeCompare(a[sortKey]);
                }
            });
        }
        renderTable(filtered);
    }

    buildMenu('weekDropdownMenu', weeks, selectedWeeks, applyCustomFilters);
    buildMenu('teamDropdownMenu', teams, selectedTeams, applyCustomFilters);
    buildMenu('posDropdownMenu', positions, selectedPositions, applyCustomFilters);

    setupDropdown('weekDropdown', 'weekDropdownBtn', 'weekDropdownMenu');
    setupDropdown('teamDropdown', 'teamDropdownBtn', 'teamDropdownMenu');
    setupDropdown('posDropdown', 'posDropdownBtn', 'posDropdownMenu');
}

function getSelectedValues(select) {
    return Array.from(select.selectedOptions).map(opt => opt.value);
}

function applyFilters() {
    const weekVals = getSelectedValues(document.getElementById('weekFilter'));
    const teamVals = getSelectedValues(document.getElementById('teamFilter'));
    const posVals = getSelectedValues(document.getElementById('posFilter'));

    let filtered = weeklyData;
    if (weekVals.length) filtered = filtered.filter(d => weekVals.includes(String(d.week)));
    if (teamVals.length) filtered = filtered.filter(d => teamVals.includes(d.team));
    if (posVals.length) filtered = filtered.filter(d => posVals.includes(d.pos));

    renderTable(filtered);
}

function renderTable(data) {
    table.innerHTML = '';
    data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.week}</td>
            <td>${row.player}</td>
            <td>${row.team}</td>
            <td>${row.pos}</td>
            <td>${row.snaps}</td>
            <td>${row.team_snaps}</td>
            <td>${row.snap_pct}</td>
            <td>${row.touches}</td>
            <td>${row.opportunities}</td>
            <td>${row.fpts_ppr}</td>
            <td class="percent-offense">${row.pct_offense}</td>
        `;
        table.appendChild(tr);
    });
}

// Sortable columns
function makeSortable() {
    const headers = document.querySelectorAll('#weeklyTable th.sortable');
    headers.forEach(header => {
        header.addEventListener('click', () => {
            const key = header.dataset.key;
            // Remove sort indicators from all
            headers.forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
            // Toggle sort order
            sortOrder[key] = sortOrder[key] === 'asc' ? 'desc' : 'asc';
            header.classList.add(sortOrder[key] === 'asc' ? 'sorted-asc' : 'sorted-desc');
            const sorted = [...weeklyData].sort((a,b) => {
                if(typeof a[key] === 'number' || !isNaN(a[key])) {
                    return sortOrder[key] === 'asc' ? a[key]-b[key] : b[key]-a[key];
                } else {
                    return sortOrder[key] === 'asc' 
                        ? a[key].localeCompare(b[key]) 
                        : b[key].localeCompare(a[key]);
                }
            });
            renderTable(sorted);
        });
    });
}
</script>
</body>
</html>
