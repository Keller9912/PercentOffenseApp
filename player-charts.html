<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Player Charts - Week by Week</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    .content {
      padding: 30px;
    }
    .chart-container {
      position: relative;
      height: 400px;
      margin-top: 30px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .toggle-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 26px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #d1d5db;
      transition: 0.3s;
      border-radius: 34px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }
    input:checked + .toggle-slider {
      background-color: #3b82f6;
    }
    input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }
    .toggle-label {
      font-weight: 600;
      color: #1f2937;
      font-size: 14px;
    }
    .no-data-message {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
      font-size: 1.1rem;
    }
    .comparison-section {
      margin-top: 20px;
      padding: 20px;
      background: #f9fafb;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }
    .comparison-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 15px;
      text-align: center;
    }
    .comparison-filters {
      display: flex;
      gap: 16px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .comparison-filters .filter-dropdown {
      min-width: 280px;
      max-width: 400px;
      flex: 1 1 280px;
    }
    @media (max-width: 768px) {
      .chart-container {
        height: 300px;
        padding: 15px;
      }
      .comparison-filters .filter-dropdown {
        min-width: 0;
        max-width: 100%;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <a href="index.html" class="back-button">← Back to Home</a>
      <h1>Fantasy Football Dashboard</h1>
      <p>Player Performance - Week by Week</p>
    </div>

    <div class="content">
      <h2 class="page-title">Player Charts</h2>
      <div style="display: flex; justify-content: center; width: 100%;">
        <div class="filters">
          <div class="filter-dropdown" id="playerDropdown">
            <button type="button" class="filter-button" id="playerDropdownBtn">Select Player <span class="filter-arrow">▼</span></button>
            <div class="filter-dropdown-menu" id="playerDropdownMenu">
              <input type="text" class="filter-search-input" id="playerSearch" placeholder="Search players..." autocomplete="off" />
              <div id="playerOptions"></div>
            </div>
          </div>
          
          <div class="filter-dropdown" id="metricDropdown">
            <button type="button" class="filter-button" id="metricDropdownBtn">% Offense <span class="filter-arrow">▼</span></button>
            <div class="filter-dropdown-menu" id="metricDropdownMenu"></div>
          </div>

          <div class="toggle-container">
            <label class="toggle-switch">
              <input type="checkbox" id="fptsToggle">
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Fantasy Points</span>
          </div>
        </div>
      </div>
      
      <div class="comparison-section">
        <div class="comparison-title">Compare Players (Optional)</div>
        <div class="comparison-filters">
          <div class="filter-dropdown" id="comparePlayer1Dropdown">
            <button type="button" class="filter-button" id="comparePlayer1DropdownBtn">Compare Player 1 <span class="filter-arrow">▼</span></button>
            <div class="filter-dropdown-menu" id="comparePlayer1DropdownMenu">
              <input type="text" class="filter-search-input" id="comparePlayer1Search" placeholder="Search players..." autocomplete="off" />
              <div id="comparePlayer1Options"></div>
            </div>
          </div>
          
          <div class="filter-dropdown" id="comparePlayer2Dropdown">
            <button type="button" class="filter-button" id="comparePlayer2DropdownBtn">Compare Player 2 <span class="filter-arrow">▼</span></button>
            <div class="filter-dropdown-menu" id="comparePlayer2DropdownMenu">
              <input type="text" class="filter-search-input" id="comparePlayer2Search" placeholder="Search players..." autocomplete="off" />
              <div id="comparePlayer2Options"></div>
            </div>
          </div>
          
          <div class="filter-dropdown" id="comparePlayer3Dropdown">
            <button type="button" class="filter-button" id="comparePlayer3DropdownBtn">Compare Player 3 <span class="filter-arrow">▼</span></button>
            <div class="filter-dropdown-menu" id="comparePlayer3DropdownMenu">
              <input type="text" class="filter-search-input" id="comparePlayer3Search" placeholder="Search players..." autocomplete="off" />
              <div id="comparePlayer3Options"></div>
            </div>
          </div>
        </div>
      </div>
      
      <div id="chartWrapper">
        <div class="no-data-message">Select a player to view their weekly performance</div>
      </div>
    </div>
  </div>

  <script>
    const url = "https://script.google.com/macros/s/AKfycbxTRNhPxu9QFv3hdYaaS0tMH7ZekFtvrGaX-d-LyXgm2LeqfXlu-ELiSZII85Gy4w2L6Q/exec";

    let allData = [];
    let allPlayers = [];
    let selectedPlayer = null;
    let comparePlayer1 = null;
    let comparePlayer2 = null;
    let comparePlayer3 = null;
    let selectedMetric = 'offense_pct';
    let showFpts = false;
    let chart = null;

    const chartColors = [
      '#3b82f6', // Blue - main player
      '#f59e0b', // Orange - compare 1
      '#8b5cf6', // Purple - compare 2
      '#ec4899'  // Pink - compare 3
    ];

    const metrics = [
      { value: 'offense_pct', label: '% Offense' },
      { value: 'targets', label: 'Targets' },
      { value: 'rushes', label: 'Rushes' },
      { value: 'opportunities', label: 'Opportunities' },
      { value: 'snaps', label: 'Snaps' }
    ];

    function closeAllDropdowns() {
      document.querySelectorAll('.filter-dropdown-menu').forEach(m => m.classList.remove('open'));
      document.querySelectorAll('.filter-button').forEach(b => b.classList.remove('open'));
    }

    function setupDropdown(dropdownId, btnId, menuId) {
      const dropdown = document.getElementById(dropdownId);
      const btn = document.getElementById(btnId);
      const menu = document.getElementById(menuId);
      btn.onclick = function(e) {
        e.stopPropagation();
        closeAllDropdowns();
        menu.classList.toggle('open');
        btn.classList.toggle('open');
      };
      document.addEventListener('click', function(e) {
        if (!dropdown.contains(e.target)) {
          menu.classList.remove('open');
          btn.classList.remove('open');
        }
      });
    }

    function renderComparePlayerOptions(compareNum, filter = "") {
      const optionsDiv = document.getElementById(`comparePlayer${compareNum}Options`);
      const lower = filter.toLowerCase();
      const comparePlayer = compareNum === 1 ? comparePlayer1 : compareNum === 2 ? comparePlayer2 : comparePlayer3;
      
      optionsDiv.innerHTML = allPlayers
        .filter(name => name.toLowerCase().includes(lower))
        .map(name => `
          <div class="filter-option${comparePlayer === name ? ' selected' : ''}" data-value="${name}">
            <span class="filter-checkmark">✔</span>
            <span class="filter-option-text">${name}</span>
          </div>
        `).join("");
      
      Array.from(optionsDiv.children).forEach(child => {
        child.onclick = function(e) {
          e.stopPropagation();
          const value = child.dataset.value;
          if (compareNum === 1) {
            comparePlayer1 = comparePlayer1 === value ? null : value;
            document.getElementById('comparePlayer1DropdownBtn').innerHTML = 
              `${comparePlayer1 || 'Compare Player 1'} <span class="filter-arrow">▼</span>`;
          } else if (compareNum === 2) {
            comparePlayer2 = comparePlayer2 === value ? null : value;
            document.getElementById('comparePlayer2DropdownBtn').innerHTML = 
              `${comparePlayer2 || 'Compare Player 2'} <span class="filter-arrow">▼</span>`;
          } else {
            comparePlayer3 = comparePlayer3 === value ? null : value;
            document.getElementById('comparePlayer3DropdownBtn').innerHTML = 
              `${comparePlayer3 || 'Compare Player 3'} <span class="filter-arrow">▼</span>`;
          }
          closeAllDropdowns();
          renderComparePlayerOptions(compareNum, document.getElementById(`comparePlayer${compareNum}Search`).value);
          updateChart();
        };
      });
    }

    function renderPlayerOptions(filter = "") {
      const optionsDiv = document.getElementById('playerOptions');
      const lower = filter.toLowerCase();
      optionsDiv.innerHTML = allPlayers
        .filter(name => name.toLowerCase().includes(lower))
        .map(name => `
          <div class="filter-option${selectedPlayer === name ? ' selected' : ''}" data-value="${name}">
            <span class="filter-checkmark">✔</span>
            <span class="filter-option-text">${name}</span>
          </div>
        `).join("");
      
      Array.from(optionsDiv.children).forEach(child => {
        child.onclick = function(e) {
          e.stopPropagation();
          selectedPlayer = child.dataset.value;
          document.getElementById('playerDropdownBtn').innerHTML = `${selectedPlayer} <span class="filter-arrow">▼</span>`;
          closeAllDropdowns();
          renderPlayerOptions(document.getElementById('playerSearch').value);
          updateChart();
        };
      });
    }

    function setupMetricDropdown() {
      const menuDiv = document.getElementById('metricDropdownMenu');
      menuDiv.innerHTML = metrics.map(m => `
        <div class="filter-option${selectedMetric === m.value ? ' selected' : ''}" data-value="${m.value}">
          <span class="filter-checkmark">✔</span>
          <span class="filter-option-text">${m.label}</span>
        </div>
      `).join('');
      
      Array.from(menuDiv.children).forEach(child => {
        child.onclick = function(e) {
          e.stopPropagation();
          selectedMetric = child.dataset.value;
          const label = metrics.find(m => m.value === selectedMetric).label;
          document.getElementById('metricDropdownBtn').innerHTML = `${label} <span class="filter-arrow">▼</span>`;
          closeAllDropdowns();
          setupMetricDropdown();
          updateChart();
        };
      });
    }

    async function loadData() {
      if (!url) return;
      
      try {
        const response = await fetch(url);
        const data = await response.json();
        console.log('Fetched API data:', data);
        
        allData = data.map(row => ({
          id: row["id"],
          name: row["player"] || "",
          pos: row["pos"] || "",
          team: row["team"] || "",
          week: Number(row["week"] || 0),
          snaps: Number(row["snaps"] || 0),
          team_snaps: Number(row["team_snaps"] || 0),
          targets: Number(row["targets"] || 0),
          rushes: Number(row["rushes"] || 0),
          opportunities: Number(row["opportunities"] || 0),
          touches: Number(row["touches"] || 0),
          fpts_ppr: Number(row["fpts_ppr"] || 0),
          offense_pct: row["team_snaps"] ? (Number(row["opportunities"] || 0) / Number(row["team_snaps"]) * 100) : 0
        }));

        allPlayers = [...new Set(allData.map(p => p.name))].sort();
        renderPlayerOptions();
        renderComparePlayerOptions(1);
        renderComparePlayerOptions(2);
        renderComparePlayerOptions(3);
        setupMetricDropdown();
        
        setupDropdown('playerDropdown', 'playerDropdownBtn', 'playerDropdownMenu');
        setupDropdown('metricDropdown', 'metricDropdownBtn', 'metricDropdownMenu');
        setupDropdown('comparePlayer1Dropdown', 'comparePlayer1DropdownBtn', 'comparePlayer1DropdownMenu');
        setupDropdown('comparePlayer2Dropdown', 'comparePlayer2DropdownBtn', 'comparePlayer2DropdownMenu');
        setupDropdown('comparePlayer3Dropdown', 'comparePlayer3DropdownBtn', 'comparePlayer3DropdownMenu');
        
        document.getElementById('playerSearch').oninput = function(e) {
          renderPlayerOptions(this.value);
        };

        document.getElementById('comparePlayer1Search').oninput = function(e) {
          renderComparePlayerOptions(1, this.value);
        };

        document.getElementById('comparePlayer2Search').oninput = function(e) {
          renderComparePlayerOptions(2, this.value);
        };

        document.getElementById('comparePlayer3Search').oninput = function(e) {
          renderComparePlayerOptions(3, this.value);
        };

        document.getElementById('fptsToggle').onchange = function() {
          showFpts = this.checked;
          updateChart();
        };
        
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    function updateChart() {
      const chartWrapper = document.getElementById('chartWrapper');
      
      if (!selectedPlayer) {
        chartWrapper.innerHTML = '<div class="no-data-message">Select a player to view their weekly performance</div>';
        return;
      }

      // Collect all players to display
      const playersToShow = [selectedPlayer];
      if (comparePlayer1) playersToShow.push(comparePlayer1);
      if (comparePlayer2) playersToShow.push(comparePlayer2);
      if (comparePlayer3) playersToShow.push(comparePlayer3);

      // Get data for all players
      const allPlayerData = playersToShow.map(playerName => {
        return allData
          .filter(d => d.name === playerName)
          .sort((a, b) => a.week - b.week);
      });

      if (allPlayerData[0].length === 0) {
        chartWrapper.innerHTML = '<div class="no-data-message">No data available for this player</div>';
        return;
      }

      // Get all unique weeks across all players
      const allWeeks = [...new Set(allPlayerData.flat().map(d => d.week))].sort((a, b) => a - b);
      const weekLabels = allWeeks.map(w => `Week ${w}`);

      const metricLabel = metrics.find(m => m.value === selectedMetric).label;

      if (chart) {
        chart.destroy();
      }

      chartWrapper.innerHTML = '<div class="chart-container"><canvas id="playerChart"></canvas></div>';
      const ctx = document.getElementById('playerChart').getContext('2d');

      // Create datasets for each player
      const datasets = playersToShow.map((playerName, idx) => {
        const playerData = allPlayerData[idx];
        const metricValues = allWeeks.map(week => {
          const weekData = playerData.find(d => d.week === week);
          return weekData ? weekData[selectedMetric] : null;
        });

        return {
          label: playerName,
          data: metricValues,
          borderColor: chartColors[idx],
          backgroundColor: chartColors[idx] + '20',
          tension: 0.4,
          spanGaps: true,
          yAxisID: 'y'
        };
      });

      if (showFpts) {
        // Add FPTS datasets for each player
        playersToShow.forEach((playerName, idx) => {
          const playerData = allPlayerData[idx];
          const fptsValues = allWeeks.map(week => {
            const weekData = playerData.find(d => d.week === week);
            return weekData ? weekData.fpts_ppr : null;
          });

          datasets.push({
            label: `${playerName} - Fantasy Points`,
            data: fptsValues,
            borderColor: chartColors[idx],
            backgroundColor: chartColors[idx] + '20',
            borderDash: [5, 5],
            tension: 0.4,
            spanGaps: true,
            yAxisID: 'y1'
          });
        });
      }

      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: weekLabels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            title: {
              display: true,
              text: `${metricLabel} by Week${playersToShow.length > 1 ? ' - Player Comparison' : ''}`,
              font: {
                size: 18,
                weight: 'bold'
              }
            },
            legend: {
              display: true,
              position: 'top',
            }
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: metricLabel
              }
            },
            y1: showFpts ? {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'Fantasy Points'
              },
              grid: {
                drawOnChartArea: false,
              }
            } : undefined
          }
        }
      });
    }

    window.addEventListener("DOMContentLoaded", () => {
      loadData().then(() => {
        // Check if player is passed in URL
        const urlParams = new URLSearchParams(window.location.search);
        const playerParam = urlParams.get('player');
        if (playerParam && allPlayers.includes(playerParam)) {
          selectedPlayer = playerParam;
          document.getElementById('playerDropdownBtn').innerHTML = `${selectedPlayer} <span class="filter-arrow">▼</span>`;
          renderPlayerOptions();
          updateChart();
        }
      });
    });
  </script>
</body>
</html>