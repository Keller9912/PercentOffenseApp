<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Season Player % Offense</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <div class="header">
  <a href="index.html" class="back-button">← Back to Home</a>
  <h1>Fantasy Football Dashboard</h1>
  <p>Player % Offense - Season Averages</p>
    </div>

    <div class="content">
      <h2 class="page-title">Season Averages</h2>
      <div style="display: flex; justify-content: center; width: 100%;">
        <div class="filters">
          <div class="filter-dropdown" id="seasonPlayerDropdown">
            <button type="button" class="filter-button" id="seasonPlayerDropdownBtn">Player <span class="filter-arrow">▼</span></button>
            <div class="filter-dropdown-menu" id="seasonPlayerDropdownMenu">
              <input type="text" class="filter-search-input" id="seasonPlayerSearch" placeholder="Search players..." autocomplete="off" />
              <div id="seasonPlayerOptions"></div>
            </div>
          </div>
          <div class="filter-dropdown" id="seasonWeekDropdown">
            <button type="button" class="filter-button" id="seasonWeekDropdownBtn">Week <span class="filter-arrow">▼</span></button>
            <div class="filter-dropdown-menu" id="seasonWeekDropdownMenu"></div>
          </div>
          <div class="filter-dropdown" id="seasonTeamDropdown">
            <button type="button" class="filter-button" id="seasonTeamDropdownBtn">Team <span class="filter-arrow">▼</span></button>
            <div class="filter-dropdown-menu" id="seasonTeamDropdownMenu"></div>
          </div>
          <div class="filter-dropdown" id="seasonPosDropdown">
            <button type="button" class="filter-button" id="seasonPosDropdownBtn">Position <span class="filter-arrow">▼</span></button>
            <div class="filter-dropdown-menu" id="seasonPosDropdownMenu"></div>
          </div>
        </div>
      </div>
      <table id="seasonTable" class="data-table">
        <thead>
          <tr>
            <th class="sortable" data-sort="name">Player Name</th>
            <th class="sortable" data-sort="pos">Pos</th>
            <th class="sortable" data-sort="team">Team</th>
            <th class="sortable" data-sort="games">Games Played</th>
            <th class="sortable" data-sort="snaps">Snaps</th>
            <th class="sortable" data-sort="targets">Targets</th>
            <th class="sortable" data-sort="rushes">Rushes</th>
            <th class="sortable" data-sort="opportunities">Opportunities</th>
            <th class="sortable" data-sort="touches">Touches</th>
            <th class="sortable" data-sort="snap_pct">Snap %</th>
            <th class="sortable" data-sort="offense_pct">% Offense</th>
          </tr>
        </thead>
        <tbody>
          <!-- Data rows will be inserted here -->
        </tbody>
      </table>
      <script>
      // Set your API URL here
      const url = "https://script.google.com/macros/s/AKfycbxTRNhPxu9QFv3hdYaaS0tMH7ZekFtvrGaX-d-LyXgm2LeqfXlu-ELiSZII85Gy4w2L6Q/exec"; // e.g., "/data.json" or your API endpoint

      async function loadSeasonData() {
        // --- Player Search Filter ---
        let allPlayers = [...new Set(playerArr.map(p => p.name))].sort();
        let selectedPlayers = [];
        function renderPlayerOptions(filter = "") {
          const optionsDiv = document.getElementById('seasonPlayerOptions');
          const lower = filter.toLowerCase();
          optionsDiv.innerHTML = allPlayers
            .filter(name => name.toLowerCase().includes(lower))
            .map(name => `
              <div class="filter-option${selectedPlayers.includes(name) ? ' selected' : ''}" data-value="${name}">
                <input type="checkbox" ${selectedPlayers.includes(name) ? 'checked' : ''} />
                <span class="filter-option-text">${name}</span>
              </div>
            `).join("");
          Array.from(optionsDiv.children).forEach(child => {
            child.onclick = function(e) {
              e.stopPropagation();
              const value = child.dataset.value;
              if (selectedPlayers.includes(value)) {
                selectedPlayers = selectedPlayers.filter(v => v !== value);
              } else {
                selectedPlayers.push(value);
              }
              renderPlayerOptions(document.getElementById('seasonPlayerSearch').value);
              applyCustomFilters();
            };
          });
        }
        document.getElementById('seasonPlayerDropdownBtn').onclick = function(e) {
          e.stopPropagation();
          closeAllDropdowns();
          document.getElementById('seasonPlayerDropdownMenu').classList.toggle('open');
          this.classList.toggle('open');
        };
        document.getElementById('seasonPlayerSearch').oninput = function(e) {
          renderPlayerOptions(this.value);
        };
        document.addEventListener('click', function(e) {
          if (!document.getElementById('seasonPlayerDropdown').contains(e.target)) {
            document.getElementById('seasonPlayerDropdownMenu').classList.remove('open');
            document.getElementById('seasonPlayerDropdownBtn').classList.remove('open');
          }
        });
        renderPlayerOptions();
        if (!url) return;
        const response = await fetch(url);
        const data = await response.json();
        console.log('Fetched API data:', data);
        const grouped = {};
        data.forEach(row => {
          const id = row["id"];
          if (!grouped[id]) {
            grouped[id] = {
              id: id,
              name: row["player"] || "",
              pos: row["pos"] || "",
              team: row["team"] || "",
              games: 0,
              snaps: 0,
              team_snaps: 0,
              targets: 0,
              rushes: 0,
              opportunities: 0,
              touches: 0,
              weeks: []
            };
          }
          grouped[id].games += 1;
          grouped[id].snaps += Number(row["snaps"] || 0);
          grouped[id].team_snaps += Number(row["team_snaps"] || 0);
          grouped[id].targets += Number(row["targets"] || 0);
          grouped[id].rushes += Number(row["rushes"] || 0);
          grouped[id].opportunities += Number(row["opportunities"] || 0);
          grouped[id].touches += Number(row["touches"] || 0);
          grouped[id].weeks.push(row["week"]);
        });

        let playerArr = Object.values(grouped).map(player => {
          const snap_pct = player.team_snaps ? (player.snaps / player.team_snaps * 100) : 0;
          const offense_pct = player.team_snaps ? (player.opportunities / player.team_snaps * 100) : 0;
          return {
            ...player,
            snap_pct: snap_pct,
            offense_pct: offense_pct
          };
        });
        console.log('Aggregated playerArr:', playerArr);

        // Custom filter logic (same as weekly)
        function buildMenu(menuId, options, selected, onChange) {
          const menu = document.getElementById(menuId);
          menu.innerHTML = options.map(opt => `
            <div class="filter-option${selected.includes(opt) ? ' selected' : ''}" data-value="${opt}">
                <span class="filter-checkmark">✔</span>
                <span class="filter-option-text">${opt}</span>
            </div>
          `).join('');
          Array.from(menu.children).forEach(child => {
            child.onclick = function(e) {
              e.stopPropagation();
              child.classList.toggle('selected');
              onChange();
            };
          });
        }

        function setupDropdown(dropdownId, btnId, menuId) {
          const dropdown = document.getElementById(dropdownId);
          const btn = document.getElementById(btnId);
          const menu = document.getElementById(menuId);
          btn.onclick = function(e) {
            e.stopPropagation();
            closeAllDropdowns();
            menu.classList.toggle('open');
            btn.classList.toggle('open');
          };
          document.addEventListener('click', function(e) {
            if (!dropdown.contains(e.target)) {
              menu.classList.remove('open');
              btn.classList.remove('open');
            }
          });
        }
        function closeAllDropdowns() {
          document.querySelectorAll('.filter-dropdown-menu').forEach(m => m.classList.remove('open'));
          document.querySelectorAll('.filter-button').forEach(b => b.classList.remove('open'));
        }

        // Get unique options
        const weeks = [...new Set(data.map(d => d.week))].sort((a,b)=>a-b);
        const teams = [...new Set(data.map(d => d.team))].sort();
        const positions = [...new Set(data.map(d => d.pos))].sort();
        let selectedWeeks = [];
        let selectedTeams = [];
        let selectedPositions = [];
  let currentFiltered = [];
  let currentSort = { column: null, asc: true };

        // Sorting and rendering helper
        function sortAndRender() {
          if (currentSort.column) {
            sortTable(currentSort.column);
            updateSortIndicators();
          } else {
            renderTable(currentFiltered);
            updateSortIndicators();
          }
        }

        function applyCustomFilters() {
          selectedWeeks = Array.from(document.querySelectorAll('#seasonWeekDropdownMenu .filter-option.selected')).map(d => d.dataset.value);
          selectedTeams = Array.from(document.querySelectorAll('#seasonTeamDropdownMenu .filter-option.selected')).map(d => d.dataset.value);
          selectedPositions = Array.from(document.querySelectorAll('#seasonPosDropdownMenu .filter-option.selected')).map(d => d.dataset.value);
          let filtered = playerArr;
          if (selectedPlayers.length) filtered = filtered.filter(p => selectedPlayers.includes(p.name));
          if (selectedWeeks.length) filtered = filtered.filter(p => p.weeks.some(w => selectedWeeks.includes(String(w))));
          if (selectedTeams.length) filtered = filtered.filter(p => selectedTeams.includes(p.team));
          if (selectedPositions.length) filtered = filtered.filter(p => selectedPositions.includes(p.pos));
          currentFiltered = filtered;
          // If a sort column is set, sort using current direction
          if (currentSort.column) {
            let sorted = [...currentFiltered].sort((a, b) => {
              let valA = a[currentSort.column];
              let valB = b[currentSort.column];
              if (["name", "team"].includes(currentSort.column)) {
                valA = valA.toLowerCase();
                valB = valB.toLowerCase();
                if (valA < valB) return currentSort.asc ? -1 : 1;
                if (valA > valB) return currentSort.asc ? 1 : -1;
                return 0;
              } else {
                valA = Number(valA);
                valB = Number(valB);
                if (valA < valB) return currentSort.asc ? -1 : 1;
                if (valA > valB) return currentSort.asc ? 1 : -1;
                return 0;
              }
            });
            currentFiltered = sorted;
          }
          renderTable(currentFiltered);
          updateSortIndicators();
        }

  buildMenu('seasonWeekDropdownMenu', weeks, selectedWeeks, applyCustomFilters);
  buildMenu('seasonTeamDropdownMenu', teams, selectedTeams, applyCustomFilters);
  buildMenu('seasonPosDropdownMenu', positions, selectedPositions, applyCustomFilters);

  setupDropdown('seasonWeekDropdown', 'seasonWeekDropdownBtn', 'seasonWeekDropdownMenu');
  setupDropdown('seasonTeamDropdown', 'seasonTeamDropdownBtn', 'seasonTeamDropdownMenu');
  setupDropdown('seasonPosDropdown', 'seasonPosDropdownBtn', 'seasonPosDropdownMenu');

  // Render table on load
  currentFiltered = [...playerArr].sort((a, b) => b.offense_pct - a.offense_pct);
  currentSort = { column: 'offense_pct', asc: false };
  renderTable(currentFiltered);
  updateSortIndicators();

        // Sorting logic
  // currentSort already declared above
        function renderTable(data) {
          const tableBody = document.querySelector('#seasonTable tbody');
          tableBody.innerHTML = "";
          if (!data || data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="11">No data available</td></tr>';
            console.warn('renderTable called with empty data:', data);
            return;
          }
          data.forEach(player => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${player.name}</td>
              <td>${player.pos}</td>
              <td>${player.team}</td>
              <td>${player.games}</td>
              <td>${player.snaps}</td>
              <td>${player.targets}</td>
              <td>${player.rushes}</td>
              <td>${player.opportunities}</td>
              <td>${player.touches}</td>
              <td>${player.snap_pct.toFixed(1)}</td>
              <td>${player.offense_pct.toFixed(1)}</td>
            `;
            tableBody.appendChild(tr);
          });
        }

        function sortTable(column) {
          if (currentSort.column === column) {
            currentSort.asc = !currentSort.asc;
          } else {
            currentSort.column = column;
            // Default to descending for offense_pct, ascending otherwise
            currentSort.asc = column === 'offense_pct' ? false : true;
          }
          let sorted = [...currentFiltered].sort((a, b) => {
            let valA = a[column];
            let valB = b[column];
            // For name/team, sort as string
            if (["name", "team"].includes(column)) {
              valA = valA.toLowerCase();
              valB = valB.toLowerCase();
              if (valA < valB) return currentSort.asc ? -1 : 1;
              if (valA > valB) return currentSort.asc ? 1 : -1;
              return 0;
            } else {
              valA = Number(valA);
              valB = Number(valB);
              if (valA < valB) return currentSort.asc ? -1 : 1;
              if (valA > valB) return currentSort.asc ? 1 : -1;
              return 0;
            }
          });
          currentFiltered = sorted;
          renderTable(currentFiltered);
        function sortAndRender() {
          if (currentSort.column) {
            sortTable(currentSort.column);
            updateSortIndicators();
          } else {
            renderTable(currentFiltered);
            updateSortIndicators();
          }
        }
        }

        // Attach sort handlers and manage sort indicators
        function updateSortIndicators() {
          document.querySelectorAll('#seasonTable th.sortable').forEach(th => {
            th.classList.remove('sorted-asc', 'sorted-desc');
            if (th.dataset.sort === currentSort.column) {
              th.classList.add(currentSort.asc ? 'sorted-asc' : 'sorted-desc');
            }
          });
        }

        document.querySelectorAll("#seasonTable th.sortable").forEach(th => {
          th.style.cursor = "pointer";
          th.onclick = () => {
            currentSort.column = th.dataset.sort;
            sortTable(th.dataset.sort);
            updateSortIndicators();
          };
        });

        renderTable(playerArr);
        updateSortIndicators();
      }

      window.addEventListener("DOMContentLoaded", loadSeasonData);
      </script>
    </div>
  </div>
</body>
</html>
